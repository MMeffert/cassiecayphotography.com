name: Process New Photos

on:
  push:
    paths:
      - 'new-photos/**'
    branches:
      - main

jobs:
  process-images:
    runs-on: ubuntu-latest
    # Don't run on commits from this workflow
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    permissions:
      contents: write
    
    concurrency:
      group: process-images
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for new images
        id: check
        run: |
          IMAGES=$(find new-photos -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | head -20)
          if [ -z "$IMAGES" ]; then
            echo "No new images found"
            echo "has_images=false" >> $GITHUB_OUTPUT
          else
            echo "Found images:"
            echo "$IMAGES"
            echo "has_images=true" >> $GITHUB_OUTPUT
          fi

      - name: Process new images
        if: steps.check.outputs.has_images == 'true'
        run: |
          for img in new-photos/*.{jpg,jpeg,png,JPG,JPEG,PNG}; do
            [ -f "$img" ] || continue
            filename=$(basename "$img")
            [[ "$filename" == ".gitkeep" ]] && continue
            echo "Moving $filename to images/"
            mv "$img" "images/$filename"
          done

      - name: Optimize images
        if: steps.check.outputs.has_images == 'true'
        run: npm run preprocess

      - name: Generate HTML snippets
        if: steps.check.outputs.has_images == 'true'
        shell: bash
        run: |
          # Get list of newly added images in this commit
          MOVED_IMAGES=$(git diff --name-only HEAD~1 -- images/ 2>/dev/null | grep -iE '\.(jpg|jpeg|png)$' | xargs -I {} basename {} 2>/dev/null | sed 's/\.[^.]*$//' || true)
          
          for filename in $MOVED_IMAGES; do
            if grep -q "href=\"images-optimized/jpeg/full/$filename.jpg\"" index.html; then
              echo "Skipping $filename - already in index.html"
              continue
            fi
            
            echo "Generating HTML for $filename"
            
            if [ -f "images-optimized/jpeg/800w/$filename.jpg" ]; then
              echo '<!-- ========== MOVE THIS BLOCK START ========== -->' >> new-images.html
              echo "<!-- Image: $filename | Category: family (options: family, milestone, senior, newborn, couples) -->" >> new-images.html
              echo '<div class="portfolio-item family">' >> new-images.html
              echo '  <div class="portfolio-item-content">' >> new-images.html
              echo "    <figure class=\"overlay overlay2\"><a href=\"images-optimized/jpeg/full/$filename.jpg\">" >> new-images.html
              echo '      <picture>' >> new-images.html
              echo "        <source srcset=\"images-optimized/avif/800w/$filename.avif 800w\" sizes=\"(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px\" type=\"image/avif\">" >> new-images.html
              echo "        <source srcset=\"images-optimized/webp/800w/$filename.webp 800w\" sizes=\"(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px\" type=\"image/webp\">" >> new-images.html
              echo "        <img src=\"images-optimized/jpeg/800w/$filename.jpg\" srcset=\"images-optimized/jpeg/800w/$filename.jpg 800w\" sizes=\"(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px\" alt=\"[ADD DESCRIPTION]\" loading=\"lazy\">" >> new-images.html
              echo '      </picture>' >> new-images.html
              echo '    </a></figure>' >> new-images.html
              echo '  </div>' >> new-images.html
              echo '</div>' >> new-images.html
              echo '<!-- ========== MOVE THIS BLOCK END ========== -->' >> new-images.html
            fi
          done

      - name: Insert HTML into index.html
        if: steps.check.outputs.has_images == 'true'
        run: |
          if [ -f "new-images.html" ]; then
            if grep -q "<!-- NEW-IMAGES-INSERT-POINT -->" index.html; then
              sed -i '/<!-- NEW-IMAGES-INSERT-POINT -->/r new-images.html' index.html
            else
              sed -i '/<!--\/.portfolio-grid -->/r new-images.html' index.html
            fi
            rm new-images.html
          fi

      - name: Commit and push
        if: steps.check.outputs.has_images == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "feat: process new portfolio images [skip ci]" || echo "No changes to commit"
          git push
