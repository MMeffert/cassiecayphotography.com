name: Process New Photos

on:
  push:
    paths:
      - 'new-photos/*.jpg'
      - 'new-photos/*.jpeg'
      - 'new-photos/*.png'
      - 'new-photos/*.JPG'
      - 'new-photos/*.JPEG'
      - 'new-photos/*.PNG'
      - 'new-photos/portfolio/**'
      - 'new-photos/services/**'
      - 'new-photos/hero/**'
    branches:
      - main

jobs:
  process-images:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    permissions:
      contents: write

    concurrency:
      group: process-images
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for new images
        id: check
        run: |
          # Check root new-photos/ (treated as portfolio) and subfolders
          ROOT_IMAGES=$(find new-photos -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) 2>/dev/null | head -20)
          PORTFOLIO_SUBFOLDER=$(find new-photos/portfolio -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) 2>/dev/null | head -20)
          PORTFOLIO="$ROOT_IMAGES $PORTFOLIO_SUBFOLDER"
          PORTFOLIO=$(echo "$PORTFOLIO" | xargs)  # trim whitespace

          SERVICES=$(find new-photos/services -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) 2>/dev/null | head -20)
          HERO=$(find new-photos/hero -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) 2>/dev/null | head -20)

          echo "has_portfolio=$( [ -n "$PORTFOLIO" ] && echo true || echo false )" >> $GITHUB_OUTPUT
          echo "has_services=$( [ -n "$SERVICES" ] && echo true || echo false )" >> $GITHUB_OUTPUT
          echo "has_hero=$( [ -n "$HERO" ] && echo true || echo false )" >> $GITHUB_OUTPUT

          if [ -n "$PORTFOLIO" ] || [ -n "$SERVICES" ] || [ -n "$HERO" ]; then
            echo "has_images=true" >> $GITHUB_OUTPUT
            echo "Found images:"
            [ -n "$PORTFOLIO" ] && echo "  Portfolio: $PORTFOLIO"
            [ -n "$SERVICES" ] && echo "  Services: $SERVICES"
            [ -n "$HERO" ] && echo "  Hero: $HERO"
          else
            echo "has_images=false" >> $GITHUB_OUTPUT
            echo "No new images found"
          fi

      - name: Process portfolio images
        id: portfolio
        if: steps.check.outputs.has_portfolio == 'true'
        run: |
          MOVED_FILES=""
          # Process from both root new-photos/ and new-photos/portfolio/
          for img in new-photos/*.{jpg,jpeg,png,JPG,JPEG,PNG} new-photos/portfolio/*.{jpg,jpeg,png,JPG,JPEG,PNG}; do
            [ -f "$img" ] || continue
            filename=$(basename "$img")
            [[ "$filename" == ".gitkeep" ]] && continue
            echo "Moving portfolio image: $filename"
            mv "$img" "images/$filename"
            basename_no_ext="${filename%.*}"
            MOVED_FILES="$MOVED_FILES $basename_no_ext"
          done
          echo "moved_files=$MOVED_FILES" >> $GITHUB_OUTPUT

      - name: Process service images (500x500 crop)
        id: services
        if: steps.check.outputs.has_services == 'true'
        run: |
          MOVED_FILES=""
          for img in new-photos/services/*.{jpg,jpeg,png,JPG,JPEG,PNG}; do
            [ -f "$img" ] || continue
            filename=$(basename "$img")
            [[ "$filename" == ".gitkeep" ]] && continue

            # Add service prefix if not already present
            if [[ "$filename" != cassiecay-service-* ]]; then
              basename_no_ext="${filename%.*}"
              ext="${filename##*.}"
              new_filename="cassiecay-service-${basename_no_ext}.${ext}"
            else
              new_filename="$filename"
            fi

            echo "Processing service image: $filename -> $new_filename (500x500 crop)"

            # Crop to 500x500 square using sharp
            node -e "
              const sharp = require('sharp');
              sharp('$img')
                .resize(500, 500, { fit: 'cover', position: 'attention' })
                .jpeg({ quality: 90 })
                .toFile('images/$new_filename')
                .then(() => console.log('Cropped successfully'))
                .catch(err => { console.error(err); process.exit(1); });
            "

            rm "$img"
            basename_no_ext="${new_filename%.*}"
            MOVED_FILES="$MOVED_FILES $basename_no_ext"
          done
          echo "moved_files=$MOVED_FILES" >> $GITHUB_OUTPUT

      - name: Process hero images
        id: hero
        if: steps.check.outputs.has_hero == 'true'
        run: |
          MOVED_FILES=""
          for img in new-photos/hero/*.{jpg,jpeg,png,JPG,JPEG,PNG}; do
            [ -f "$img" ] || continue
            filename=$(basename "$img")
            [[ "$filename" == ".gitkeep" ]] && continue

            # Add slider prefix if not already present
            if [[ "$filename" != cassiecay-slider* ]]; then
              basename_no_ext="${filename%.*}"
              ext="${filename##*.}"
              new_filename="cassiecay-slider-${basename_no_ext}.${ext}"
            else
              new_filename="$filename"
            fi

            echo "Moving hero image: $filename -> $new_filename"
            mv "$img" "images/$new_filename"
            basename_no_ext="${new_filename%.*}"
            MOVED_FILES="$MOVED_FILES $basename_no_ext"
          done
          echo "moved_files=$MOVED_FILES" >> $GITHUB_OUTPUT

      - name: Optimize images
        if: steps.check.outputs.has_images == 'true'
        run: npm run preprocess

      - name: Generate portfolio HTML
        if: steps.check.outputs.has_portfolio == 'true'
        run: |
          for filename in ${{ steps.portfolio.outputs.moved_files }}; do
            if grep -q "href=\"images-optimized/jpeg/full/$filename.jpg\"" index.html; then
              echo "Skipping $filename - already in index.html"
              continue
            fi

            echo "Generating portfolio HTML for $filename"

            if [ -f "images-optimized/jpeg/800w/$filename.jpg" ]; then
              cat >> new-images.html << 'HTMLEOF'
<!-- ========== MOVE THIS BLOCK START ========== -->
HTMLEOF
              echo "<!-- Image: $filename | Category: family (options: family, milestone, senior, newborn, couples, wedding) -->" >> new-images.html
              cat >> new-images.html << HTMLEOF
<div class="portfolio-item family">
  <div class="portfolio-item-content">
    <figure class="overlay overlay2"><a href="images-optimized/jpeg/full/$filename.jpg">
      <picture>
        <source srcset="images-optimized/avif/800w/$filename.avif 800w" sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px" type="image/avif">
        <source srcset="images-optimized/webp/800w/$filename.webp 800w" sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px" type="image/webp">
        <img src="images-optimized/jpeg/800w/$filename.jpg" srcset="images-optimized/jpeg/800w/$filename.jpg 800w" sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px" alt="[ADD DESCRIPTION]" loading="lazy">
      </picture>
    </a></figure>
  </div>
</div>
<!-- ========== MOVE THIS BLOCK END ========== -->
HTMLEOF
            fi
          done

      - name: Generate service HTML
        if: steps.check.outputs.has_services == 'true'
        run: |
          for filename in ${{ steps.services.outputs.moved_files }}; do
            if grep -q "images-optimized/jpeg/full/$filename.jpg" index.html; then
              echo "Skipping $filename - already in index.html"
              continue
            fi

            echo "Generating service HTML for $filename"

            if [ -f "images-optimized/jpeg/full/$filename.jpg" ]; then
              cat >> new-services.html << HTMLEOF
<!-- ========== NEW SERVICE IMAGE: $filename ========== -->
<!-- Copy this block to replace an existing service image -->
<figure><picture>
  <source srcset="images-optimized/avif/full/$filename.avif" type="image/avif">
  <source srcset="images-optimized/webp/full/$filename.webp" type="image/webp">
  <img class="octagon" src="images-optimized/jpeg/full/$filename.jpg" alt="[ADD DESCRIPTION]">
</picture></figure>
<!-- ========== END SERVICE IMAGE ========== -->
HTMLEOF
            fi
          done

      - name: Generate hero HTML
        if: steps.check.outputs.has_hero == 'true'
        run: |
          for filename in ${{ steps.hero.outputs.moved_files }}; do
            if grep -q "images-optimized/jpeg/full/$filename.jpg" index.html; then
              echo "Skipping $filename - already in index.html"
              continue
            fi

            echo "Generating hero HTML for $filename"

            if [ -f "images-optimized/jpeg/full/$filename.jpg" ]; then
              cat >> new-hero.html << HTMLEOF
<!-- ========== NEW HERO SLIDE: $filename ========== -->
<!-- Add this inside the .embla__container div -->
<div class="embla__slide">
  <img src="images-optimized/jpeg/full/$filename.jpg" alt="[ADD DESCRIPTION]">
</div>
<!-- ========== END HERO SLIDE ========== -->
HTMLEOF
            fi
          done

      - name: Insert portfolio HTML into index.html
        if: steps.check.outputs.has_portfolio == 'true'
        run: |
          if [ -f "new-images.html" ]; then
            if grep -q "<!-- NEW-IMAGES-INSERT-POINT -->" index.html; then
              sed -i '/<!-- NEW-IMAGES-INSERT-POINT -->/r new-images.html' index.html
            else
              sed -i '/<!--\/.portfolio-grid -->/r new-images.html' index.html
            fi
            rm new-images.html
          fi

      - name: Append service/hero HTML as comments
        run: |
          # Service images need manual placement, append to end of file as reference
          if [ -f "new-services.html" ]; then
            echo "" >> index.html
            echo "<!-- ========== NEW SERVICE IMAGES TO PLACE ========== -->" >> index.html
            cat new-services.html >> index.html
            rm new-services.html
          fi

          # Hero images need manual placement in slider
          if [ -f "new-hero.html" ]; then
            echo "" >> index.html
            echo "<!-- ========== NEW HERO SLIDES TO PLACE ========== -->" >> index.html
            cat new-hero.html >> index.html
            rm new-hero.html
          fi

      - name: Commit and push
        if: steps.check.outputs.has_images == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          # Build commit message based on what was processed
          MSG="feat: process new images"
          [ "${{ steps.check.outputs.has_portfolio }}" == "true" ] && MSG="$MSG (portfolio)"
          [ "${{ steps.check.outputs.has_services }}" == "true" ] && MSG="$MSG (services)"
          [ "${{ steps.check.outputs.has_hero }}" == "true" ] && MSG="$MSG (hero)"
          MSG="$MSG [skip ci]"

          git commit -m "$MSG" || echo "No changes to commit"
          git push
