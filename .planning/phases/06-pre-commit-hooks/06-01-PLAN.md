---
phase: 06-pre-commit-hooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .husky/pre-commit
  - scripts/validate-staged.js
autonomous: true

must_haves:
  truths:
    - "Git commit blocked if referenced images are missing"
    - "Git commit blocked if HTML has obvious errors"
    - "Pre-commit runs in under 5 seconds for typical changes"
    - "Clear error messages tell Cassie what to fix"
  artifacts:
    - path: ".husky/pre-commit"
      provides: "Git pre-commit hook"
      contains: "npm run validate:staged"
    - path: "scripts/validate-staged.js"
      provides: "Staged file validation combining HTML and reference checks"
      exports: []
    - path: "package.json"
      provides: "Husky and lint-staged configuration"
      contains: "husky"
  key_links:
    - from: ".husky/pre-commit"
      to: "scripts/validate-staged.js"
      via: "npm run validate:staged"
      pattern: "validate:staged"
    - from: "scripts/validate-staged.js"
      to: "scripts/validate-html.js"
      via: "validation logic reuse"
      pattern: "html-validate"
---

<objective>
Set up Husky pre-commit hooks to catch HTML errors and missing image references before commits reach CI.

Purpose: Faster feedback loop - Cassie sees errors immediately on commit instead of waiting for CI to fail.
Output: Working pre-commit hook that blocks commits with validation errors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/roadmap/ROADMAP.md
@package.json
@scripts/validate-html.js
@scripts/check-references.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Husky v9 and create pre-commit hook</name>
  <files>package.json, .husky/pre-commit</files>
  <action>
1. Install Husky v9 as dev dependency:
   ```bash
   npm install --save-dev husky
   ```

2. Initialize Husky (creates .husky directory):
   ```bash
   npx husky init
   ```
   This creates `.husky/pre-commit` with a sample script.

3. Update `.husky/pre-commit` to run staged validation:
   ```bash
   npm run validate:staged
   ```

4. Add prepare script to package.json (Husky v9 pattern):
   ```json
   "prepare": "husky"
   ```

Note: Do NOT use lint-staged. The existing validation scripts need to run on the full project because:
- HTML validation checks index.html (the only HTML file)
- Reference checking needs full context (image paths are relative)
- Running on staged files alone would miss cross-file dependencies

The pre-commit will be fast because:
- index.html validation takes <1 second
- Reference checking runs on one file
- No npm install or build step in hook
  </action>
  <verify>
- `cat .husky/pre-commit` shows npm run validate:staged
- `grep -q "husky" package.json` confirms husky in devDependencies
- `grep -q '"prepare"' package.json` confirms prepare script exists
  </verify>
  <done>Husky installed, .husky/pre-commit exists with validate:staged command, prepare script added</done>
</task>

<task type="auto">
  <name>Task 2: Create staged validation script</name>
  <files>scripts/validate-staged.js, package.json</files>
  <action>
Create `scripts/validate-staged.js` that:

1. Runs HTML validation (reusing logic from validate-html.js)
2. Runs reference checking (reusing logic from check-references.js)
3. Prints clear, actionable error messages for non-technical users
4. Exits non-zero if any validation fails (blocks commit)

The script should:
- Import and reuse the html-validate configuration from validate-html.js
- Import and reuse reference extraction from check-references.js
- Add user-friendly error formatting with suggestions
- Run both checks and aggregate results

Key implementation details:
- Use ES modules (import/export) to match existing scripts
- Target <3 seconds total runtime
- Format errors like:
  ```
  PRE-COMMIT FAILED

  HTML Error: Duplicate ID "message" found
    -> Fix: Ensure each element has a unique id attribute
    -> File: index.html, line 123

  Missing Image: images/gallery/photo.jpg
    -> Referenced in: index.html
    -> Fix: Add the image file or remove the reference
  ```

Add npm script to package.json:
```json
"validate:staged": "node scripts/validate-staged.js"
```
  </action>
  <verify>
- `node scripts/validate-staged.js` runs without error (current site should pass)
- Script completes in under 3 seconds
- Error output is clear and actionable when validation fails
  </verify>
  <done>validate-staged.js created, runs HTML and reference validation, exits non-zero on errors</done>
</task>

<task type="auto">
  <name>Task 3: Test pre-commit hook end-to-end</name>
  <files>None (testing only)</files>
  <action>
Test the complete pre-commit flow:

1. Make a trivial change and commit to verify hook runs:
   ```bash
   echo "# test" >> README.md
   git add README.md
   git commit -m "test: verify pre-commit hook"
   ```
   Expected: Commit succeeds, hook output shows validation passed

2. Test that hook blocks bad commits by temporarily breaking index.html:
   - Add a duplicate id attribute
   - Try to commit
   - Expected: Commit blocked with clear error message
   - Revert the change

3. Measure hook timing:
   ```bash
   time git commit --amend --no-edit
   ```
   Expected: Total time under 5 seconds

4. Reset test commit if needed:
   ```bash
   git reset HEAD~1
   git checkout README.md
   ```
  </action>
  <verify>
- Valid commits succeed
- Invalid commits (duplicate IDs) are blocked
- Error messages are clear and actionable
- Hook completes in under 5 seconds
  </verify>
  <done>Pre-commit hook tested end-to-end, blocks invalid commits, runs fast</done>
</task>

</tasks>

<verification>
1. Run `npm run validate:staged` - should pass on current codebase
2. Time the validation: `time npm run validate:staged` - should be under 3 seconds
3. Make a test commit to verify hook triggers
4. Introduce a validation error and verify commit is blocked
</verification>

<success_criteria>
- Husky v9 installed and configured with prepare script
- Pre-commit hook runs validate:staged on every commit
- Validation completes in under 5 seconds
- Clear error messages help Cassie fix issues
- Valid commits succeed, invalid commits are blocked
</success_criteria>

<output>
After completion, create `.planning/phases/06-pre-commit-hooks/06-01-SUMMARY.md`
</output>
