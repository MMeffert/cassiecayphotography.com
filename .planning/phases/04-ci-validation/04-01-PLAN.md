---
phase: 04-ci-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - scripts/validate-html.js
  - scripts/check-references.js
  - .github/workflows/deploy.yml
autonomous: true

must_haves:
  truths:
    - "CI fails if HTML contains malformed tags"
    - "CI fails if HTML references images that do not exist"
    - "CI fails if internal links point to missing files"
  artifacts:
    - path: "scripts/validate-html.js"
      provides: "HTML validation script"
      exports: []
    - path: "scripts/check-references.js"
      provides: "Link and image reference checker"
      exports: []
    - path: ".github/workflows/deploy.yml"
      provides: "CI workflow with validation job"
      contains: "validate:"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "scripts/validate-html.js"
      via: "npm run validate:html"
      pattern: "npm run validate:html"
    - from: ".github/workflows/deploy.yml"
      to: "scripts/check-references.js"
      via: "npm run validate:refs"
      pattern: "npm run validate:refs"
---

<objective>
Add HTML validation and reference checking to CI pipeline

Purpose: Catch broken HTML, missing images, and broken links before deployment to prevent site errors
Output: CI workflow that fails build on validation errors, with clear error messages showing what to fix
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-build-foundation/02-01-SUMMARY.md
@.github/workflows/deploy.yml
@package.json
@vite.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install html-validate and create validation script</name>
  <files>package.json, scripts/validate-html.js</files>
  <action>
Install html-validate as a dev dependency:
```bash
npm install --save-dev html-validate
```

Create `scripts/validate-html.js` that:
1. Uses html-validate to check index.html (the only HTML file)
2. Configures rules appropriate for this legacy site:
   - Disable `no-deprecated-attr` (legacy Revolution Slider uses deprecated attributes)
   - Disable `no-inline-style` (existing inline styles are acceptable)
   - Enable `element-permitted-content`, `no-dup-id`, `no-dup-attr`
   - Enable `void-content`, `close-order`, `element-required-attributes`
3. Reports errors with file, line, and message
4. Exits with code 1 on errors, 0 on success

Add npm script to package.json:
```json
"validate:html": "node scripts/validate-html.js"
```

Use html-validate programmatic API (not CLI) for better control over output.
  </action>
  <verify>
```bash
npm run validate:html
# Should complete successfully (index.html has valid structure)
```
  </verify>
  <done>html-validate installed, validation script exists, npm script runs without error on current index.html</done>
</task>

<task type="auto">
  <name>Task 2: Create reference checker for images and internal links</name>
  <files>scripts/check-references.js, package.json</files>
  <action>
Create `scripts/check-references.js` that:
1. Parses index.html using a simple regex or cheerio-like approach (use `node-html-parser` - already light)
2. Extracts all image references:
   - `<img src="...">` attributes
   - `<source srcset="...">` attributes (picture elements)
   - `<a data-src="...">` for lightbox images
   - CSS `url(...)` in inline styles (if any)
3. Extracts internal link hrefs (`<a href="...">` that don't start with http/https/#)
4. For each reference:
   - Check if file exists in project root OR in images-optimized/
   - For srcset, parse each path (comma-separated with widths)
5. Reports missing files with the HTML element context
6. Exits with code 1 if any references are broken, 0 if all valid

Add npm script:
```json
"validate:refs": "node scripts/check-references.js"
```

Install node-html-parser (lightweight, no native deps):
```bash
npm install --save-dev node-html-parser
```

Important: Skip external URLs (http://, https://, //, data:, #anchors).
Important: Handle picture element structure - srcset paths include width descriptors like "800w".
  </action>
  <verify>
```bash
npm run validate:refs
# Should pass (Phase 03-04 fixed all broken references)
```
  </verify>
  <done>Reference checker script exists, detects missing images and broken links, npm script runs successfully</done>
</task>

<task type="auto">
  <name>Task 3: Add validation job to GitHub Actions workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Update `.github/workflows/deploy.yml` to add a validation job that runs BEFORE deploy:

1. Add a `validate` job that:
   - Runs on ubuntu-latest
   - Checks out code
   - Sets up Node.js (use node 20)
   - Runs `npm ci` (install deps)
   - Runs `npm run validate:html`
   - Runs `npm run validate:refs`
   - Runs `npm run build` (verifies Vite build succeeds)

2. Make `deploy` job depend on `validate` job:
   - Add `needs: validate` to deploy job
   - Deploy only runs if validate passes

3. Keep existing deploy job structure but ensure it also runs npm ci and build

Workflow structure:
```yaml
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run validate:html
      - run: npm run validate:refs
      - run: npm run build

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    environment: production
    # ... existing deploy steps
```

Note: The deploy job needs to run npm ci and npm run build again (GitHub Actions jobs are isolated).
Update the S3 sync to sync from `dist/` instead of root (Vite build output).
  </action>
  <verify>
```bash
# Verify workflow syntax
cat .github/workflows/deploy.yml | head -80

# Verify locally that scripts work
npm run validate:html && npm run validate:refs && npm run build
```
  </verify>
  <done>GitHub Actions workflow has validate job that blocks deploy on validation failures, deploy syncs dist/ directory</done>
</task>

</tasks>

<verification>
1. Run validation scripts locally:
   ```bash
   npm run validate:html
   npm run validate:refs
   npm run build
   ```
   All should pass.

2. Verify workflow structure:
   - validate job exists with all validation steps
   - deploy job has `needs: validate`
   - S3 sync uses dist/ directory

3. Test failure detection (optional):
   - Temporarily add `<img src="nonexistent.jpg">` to index.html
   - Run `npm run validate:refs` - should fail
   - Revert the change
</verification>

<success_criteria>
- [ ] html-validate installed and configured
- [ ] validate:html script passes on current index.html
- [ ] validate:refs script detects missing image/link references
- [ ] GitHub Actions validate job runs before deploy
- [ ] Deploy job depends on validate job (needs: validate)
- [ ] S3 sync uses dist/ directory (Vite build output)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ci-validation/04-01-SUMMARY.md`
</output>
