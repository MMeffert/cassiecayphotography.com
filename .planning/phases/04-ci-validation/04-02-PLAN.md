---
phase: 04-ci-validation
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - scripts/check-image-sizes.js
  - package.json
  - .github/workflows/deploy.yml
autonomous: false

must_haves:
  truths:
    - "CI warns if images exceed 500KB threshold"
    - "Lighthouse performance score visible in deploy output"
    - "All validation completes in under 2 minutes"
  artifacts:
    - path: "scripts/check-image-sizes.js"
      provides: "Image size validation with warnings"
      exports: []
    - path: ".github/workflows/deploy.yml"
      provides: "Complete CI workflow with Lighthouse"
      contains: "lighthouse"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "scripts/check-image-sizes.js"
      via: "npm run validate:images"
      pattern: "npm run validate:images"
---

<objective>
Add image size warnings and Lighthouse performance checks to CI pipeline

Purpose: Warn about oversized images and provide visibility into performance scores before deployment
Output: CI workflow that warns on large images and displays Lighthouse scores in job output
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-ci-validation/04-01-SUMMARY.md
@.github/workflows/deploy.yml
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image size validation script</name>
  <files>scripts/check-image-sizes.js, package.json</files>
  <action>
Create `scripts/check-image-sizes.js` that:
1. Scans images/ and images-optimized/ directories
2. Checks file sizes against 500KB threshold
3. Reports warnings (not errors) for oversized files:
   - Yellow/warning output: "WARNING: path/to/image.jpg is 1.2MB (exceeds 500KB)"
   - Include count at end: "Found 3 images exceeding 500KB threshold"
4. Exits with code 0 regardless (warnings, not failures)
5. Groups warnings by directory for readability

Use fs.statSync for file sizes, glob for file discovery.

Add npm script:
```json
"validate:images": "node scripts/check-image-sizes.js"
```

Note: This is a WARNING tool, not a blocker. Large images in the original images/ folder are expected (they get optimized to images-optimized/). The real concern is if optimized images are still large.

Adjust logic:
- For images-optimized/: Warn at 500KB (these should be optimized)
- For images/: Warn at 2MB (originals can be larger, informational only)
  </action>
  <verify>
```bash
npm run validate:images
# Should complete, may show warnings for large originals
```
  </verify>
  <done>Image size checker script exists, reports warnings for oversized files, npm script runs</done>
</task>

<task type="auto">
  <name>Task 2: Add Lighthouse CI to workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Update `.github/workflows/deploy.yml` validate job to add Lighthouse:

1. Add image size check step (warning only, continues on failure):
   ```yaml
   - name: Check image sizes
     run: npm run validate:images
     continue-on-error: true
   ```

2. Add Lighthouse CI after build succeeds:
   ```yaml
   - name: Install Lighthouse CI
     run: npm install -g @lhci/cli

   - name: Run Lighthouse CI
     run: |
       lhci autorun --collect.staticDistDir=./dist --collect.url=http://localhost/index.html --upload.target=temporary-public-storage
     env:
       LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
     continue-on-error: true
   ```

Actually, simpler approach without LHCI server - just output scores to console:
```yaml
- name: Run Lighthouse
  run: |
    npm install -g lighthouse
    npx serve dist -l 5000 &
    sleep 3
    lighthouse http://localhost:5000 --output=json --output-path=./lighthouse-report.json --chrome-flags="--headless --no-sandbox"
    node -e "const r=require('./lighthouse-report.json'); console.log('Lighthouse Scores:'); console.log('  Performance:', r.categories.performance.score * 100); console.log('  Accessibility:', r.categories.accessibility.score * 100); console.log('  Best Practices:', r.categories['best-practices'].score * 100); console.log('  SEO:', r.categories.seo.score * 100);"
    pkill -f "serve dist" || true
```

Wait - GitHub Actions ubuntu runners have Chrome. Let's use lighthouse directly:
```yaml
- name: Run Lighthouse
  run: |
    npm install -g lighthouse serve
    npx serve dist -l 5000 &
    sleep 3
    lighthouse http://localhost:5000 --output=json --output-path=./lighthouse-report.json --chrome-flags="--headless --no-sandbox --disable-gpu"
    cat lighthouse-report.json | node -e "const chunks=[]; process.stdin.on('data',c=>chunks.push(c)); process.stdin.on('end',()=>{const r=JSON.parse(chunks.join('')); console.log(''); console.log('=== Lighthouse Scores ==='); console.log('Performance:    ', Math.round(r.categories.performance.score * 100)); console.log('Accessibility:  ', Math.round(r.categories.accessibility.score * 100)); console.log('Best Practices: ', Math.round(r.categories['best-practices'].score * 100)); console.log('SEO:            ', Math.round(r.categories.seo.score * 100)); console.log('=========================');});"
  continue-on-error: true
```

This outputs scores to the job log, visible in GitHub Actions UI.
  </action>
  <verify>
```bash
# Verify workflow syntax (no YAML errors)
cat .github/workflows/deploy.yml

# Local Lighthouse test (if Chrome available)
npm run build
npx serve dist -l 5000 &
sleep 2
lighthouse http://localhost:5000 --output=json --chrome-flags="--headless" 2>/dev/null | head -50
pkill -f "serve dist" || true
```
  </verify>
  <done>Lighthouse runs in CI, performance scores visible in job output</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete CI validation pipeline with HTML validation, reference checking, image size warnings, and Lighthouse performance scores</what-built>
  <how-to-verify>
1. Push a commit to trigger the GitHub Actions workflow
2. Watch the workflow run in GitHub Actions UI:
   - Validate job should run first
   - HTML validation should pass
   - Reference checking should pass
   - Image size warnings should display (informational)
   - Lighthouse scores should appear in output
   - Deploy job should run after validate succeeds
3. Verify total validation time is under 2 minutes
4. Check that the site still works at https://cassiecayphotography.com after deploy
  </how-to-verify>
  <resume-signal>Type "approved" if workflow runs correctly and site deploys successfully, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. All validation scripts run locally:
   ```bash
   npm run validate:html && npm run validate:refs && npm run validate:images && npm run build
   ```

2. Workflow file is valid YAML with correct structure

3. End-to-end test via GitHub Actions push
</verification>

<success_criteria>
- [ ] validate:images script warns about oversized files (doesn't fail)
- [ ] Lighthouse runs in CI and outputs scores to log
- [ ] Validation job completes in under 2 minutes
- [ ] Deploy job only runs after validate succeeds
- [ ] Site deploys successfully with new workflow
- [ ] User verifies workflow run in GitHub Actions UI
</success_criteria>

<output>
After completion, create `.planning/phases/04-ci-validation/04-02-SUMMARY.md`
</output>
