---
phase: 05-notifications-feedback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infrastructure/lib/github-oidc-stack.ts
  - .github/workflows/deploy.yml
autonomous: true

must_haves:
  truths:
    - "Mitchell receives email when deploy succeeds"
    - "Mitchell receives email when deploy fails"
    - "Success email includes Lighthouse scores"
    - "Success email includes link to site"
    - "Failure email includes error summary"
  artifacts:
    - path: "infrastructure/lib/github-oidc-stack.ts"
      provides: "SES send permissions for GitHub Actions role"
      contains: "ses:SendEmail"
    - path: ".github/workflows/deploy.yml"
      provides: "Notification steps for success and failure"
      contains: "aws ses send-email"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "AWS SES"
      via: "OIDC role with SES permissions"
      pattern: "ses send-email"
    - from: "validate job"
      to: "deploy job"
      via: "job outputs for Lighthouse scores"
      pattern: "needs\\.validate\\.outputs\\."
---

<objective>
Add deploy notifications via AWS SES so Mitchell knows immediately when deploys succeed or fail.

Purpose: Mitchell shouldn't have to check GitHub to know if a deploy worked. Email notifications provide instant feedback with relevant details (Lighthouse scores on success, error summary on failure).

Output: Updated workflow with notification steps, OIDC role with SES permissions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/roadmap/ROADMAP.md
@.planning/STATE.md
@.github/workflows/deploy.yml
@infrastructure/lib/github-oidc-stack.ts
@infrastructure/lib/contact-form-stack.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SES permissions to GitHub OIDC role</name>
  <files>infrastructure/lib/github-oidc-stack.ts</files>
  <action>
Add a new IAM policy statement to the deploymentRole that grants SES send permissions:

```typescript
// SES permissions for deploy notifications
this.deploymentRole.addToPolicy(
  new iam.PolicyStatement({
    sid: 'SESNotificationPermissions',
    effect: iam.Effect.ALLOW,
    actions: ['ses:SendEmail'],
    resources: ['*'],
    conditions: {
      StringEquals: {
        'ses:FromAddress': 'no-reply@cassiecayphotography.com',
      },
    },
  })
);
```

Place after the CloudFront permissions block (~line 95).

Note: SES is already configured with verified sender `no-reply@cassiecayphotography.com` (see contact-form-stack.ts).
  </action>
  <verify>
Run `cd infrastructure && npm run build` to verify TypeScript compiles.
Deploy: `export AWS_PROFILE=personal && cd infrastructure && npx cdk deploy CassiePhotoGitHubOidcStack --require-approval never`
  </verify>
  <done>OIDC role has ses:SendEmail permission with FromAddress condition</done>
</task>

<task type="auto">
  <name>Task 2: Add notification steps to deploy workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Modify the workflow to:

1. In the `validate` job, add outputs declaration and score extraction:

   Add `outputs` section to validate job definition:
   ```yaml
   validate:
     runs-on: ubuntu-latest
     outputs:
       performance: ${{ steps.lighthouse-scores.outputs.performance }}
       accessibility: ${{ steps.lighthouse-scores.outputs.accessibility }}
       best-practices: ${{ steps.lighthouse-scores.outputs.best-practices }}
       seo: ${{ steps.lighthouse-scores.outputs.seo }}
     steps:
       # ... existing steps ...
   ```

   After the Lighthouse step, add score extraction step:
   ```yaml
   - name: Extract Lighthouse scores
     id: lighthouse-scores
     run: |
       # Find the lighthouse report JSON file
       REPORT_FILE=$(find . -name "lighthouse-report.json" -type f | head -1)
       if [ -z "$REPORT_FILE" ]; then
         echo "Warning: No lighthouse-report.json found"
         echo "performance=N/A" >> $GITHUB_OUTPUT
         echo "accessibility=N/A" >> $GITHUB_OUTPUT
         echo "best-practices=N/A" >> $GITHUB_OUTPUT
         echo "seo=N/A" >> $GITHUB_OUTPUT
         exit 0
       fi

       # Extract scores (multiply by 100 for percentage)
       PERF=$(jq '.categories.performance.score * 100 | floor' "$REPORT_FILE")
       A11Y=$(jq '.categories.accessibility.score * 100 | floor' "$REPORT_FILE")
       BP=$(jq '.categories["best-practices"].score * 100 | floor' "$REPORT_FILE")
       SEO=$(jq '.categories.seo.score * 100 | floor' "$REPORT_FILE")

       echo "performance=$PERF" >> $GITHUB_OUTPUT
       echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
       echo "best-practices=$BP" >> $GITHUB_OUTPUT
       echo "seo=$SEO" >> $GITHUB_OUTPUT

       echo "Lighthouse Scores: Perf=$PERF, A11y=$A11Y, BP=$BP, SEO=$SEO"
   ```

2. In the `deploy` job, add a final success notification step:
   - Runs after CloudFront invalidation
   - Reference Lighthouse scores via `${{ needs.validate.outputs.performance }}` etc.
   - Uses AWS CLI to send email via SES

   ```yaml
   - name: Send success notification
     run: |
       aws ses send-email \
         --from "no-reply@cassiecayphotography.com" \
         --destination "ToAddresses=mitchell@mitchellmeffert.com" \
         --message "Subject={Data='Deploy Success: cassiecayphotography.com'},Body={Text={Data='Deployment completed successfully!

   Site: https://cassiecayphotography.com
   Commit: ${{ github.sha }} - ${{ github.event.head_commit.message }}
   Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

   Lighthouse Scores:
   - Performance: ${{ needs.validate.outputs.performance }}
   - Accessibility: ${{ needs.validate.outputs.accessibility }}
   - Best Practices: ${{ needs.validate.outputs.best-practices }}
   - SEO: ${{ needs.validate.outputs.seo }}

   View workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'}}"
   ```

3. Add a new `notify-failure` job:
   - Use `if: always() && (needs.validate.result == 'failure' || needs.deploy.result == 'failure')` condition
   - `needs: [validate, deploy]` to access their results
   - Send email with: which job failed, link to workflow run, commit SHA, error context

   ```yaml
   notify-failure:
     runs-on: ubuntu-latest
     needs: [validate, deploy]
     if: always() && (needs.validate.result == 'failure' || needs.deploy.result == 'failure')
     permissions:
       id-token: write
       contents: read
     steps:
       - name: Configure AWS credentials
         uses: aws-actions/configure-aws-credentials@v4
         with:
           role-to-assume: arn:aws:iam::241654197557:role/GitHubActionsDeployRole
           aws-region: us-east-1

       - name: Determine failed job
         id: failed-job
         run: |
           if [ "${{ needs.validate.result }}" == "failure" ]; then
             echo "job=validate" >> $GITHUB_OUTPUT
           elif [ "${{ needs.deploy.result }}" == "failure" ]; then
             echo "job=deploy" >> $GITHUB_OUTPUT
           else
             echo "job=unknown" >> $GITHUB_OUTPUT
           fi

       - name: Send failure notification
         run: |
           aws ses send-email \
             --from "no-reply@cassiecayphotography.com" \
             --destination "ToAddresses=mitchell@mitchellmeffert.com" \
             --message "Subject={Data='Deploy Failed: cassiecayphotography.com'},Body={Text={Data='Deployment failed!

   Failed job: ${{ steps.failed-job.outputs.job }}
   Commit: ${{ github.sha }} - ${{ github.event.head_commit.message }}
   Time: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")

   View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'}}"
   ```

Recipient: mitchell@mitchellmeffert.com (not Cassie - per user requirement)
Sender: no-reply@cassiecayphotography.com

Important: The notify-failure job needs its own AWS credentials step since it may run when deploy job fails.
  </action>
  <verify>
1. Push a test commit and verify workflow runs
2. Check email received within 2 minutes of completion
3. Verify Lighthouse scores appear in success email
4. To test failure notification: temporarily break build (e.g., invalid HTML), push, verify failure email, then revert
  </verify>
  <done>Deploy workflow sends success email with Lighthouse scores, failure email with error context</done>
</task>

</tasks>

<verification>
1. Trigger deploy by pushing a change (or workflow_dispatch)
2. Verify success email arrives at mitchell@mitchellmeffert.com within 2 minutes
3. Success email contains:
   - Link to https://cassiecayphotography.com
   - All 4 Lighthouse scores
   - Commit info
4. (Optional) Trigger failure by temporarily breaking build, verify failure email arrives
</verification>

<success_criteria>
- Mitchell receives email when deploy succeeds (with site link and Lighthouse scores)
- Mitchell receives email when deploy fails (with error summary and workflow link)
- Notifications arrive within 2 minutes of deploy completion
- Uses existing SES infrastructure (no new services)
</success_criteria>

<output>
After completion, create `.planning/phases/05-notifications-feedback/05-01-SUMMARY.md`
</output>
