---
phase: 05-notifications-feedback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infrastructure/lib/github-oidc-stack.ts
  - .github/workflows/deploy.yml
autonomous: true

must_haves:
  truths:
    - "Mitchell receives email when deploy succeeds"
    - "Mitchell receives email when deploy fails"
    - "Success email includes Lighthouse scores"
    - "Success email includes link to site"
    - "Failure email includes error summary"
  artifacts:
    - path: "infrastructure/lib/github-oidc-stack.ts"
      provides: "SES send permissions for GitHub Actions role"
      contains: "ses:SendEmail"
    - path: ".github/workflows/deploy.yml"
      provides: "Notification steps for success and failure"
      contains: "aws ses send-email"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "AWS SES"
      via: "OIDC role with SES permissions"
      pattern: "ses send-email"
---

<objective>
Add deploy notifications via AWS SES so Mitchell knows immediately when deploys succeed or fail.

Purpose: Mitchell shouldn't have to check GitHub to know if a deploy worked. Email notifications provide instant feedback with relevant details (Lighthouse scores on success, error summary on failure).

Output: Updated workflow with notification steps, OIDC role with SES permissions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/roadmap/ROADMAP.md
@.planning/STATE.md
@.github/workflows/deploy.yml
@infrastructure/lib/github-oidc-stack.ts
@infrastructure/lib/contact-form-stack.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SES permissions to GitHub OIDC role</name>
  <files>infrastructure/lib/github-oidc-stack.ts</files>
  <action>
Add a new IAM policy statement to the deploymentRole that grants SES send permissions:

```typescript
// SES permissions for deploy notifications
this.deploymentRole.addToPolicy(
  new iam.PolicyStatement({
    sid: 'SESNotificationPermissions',
    effect: iam.Effect.ALLOW,
    actions: ['ses:SendEmail'],
    resources: ['*'],
    conditions: {
      StringEquals: {
        'ses:FromAddress': 'no-reply@cassiecayphotography.com',
      },
    },
  })
);
```

Place after the CloudFront permissions block (~line 95).

Note: SES is already configured with verified sender `no-reply@cassiecayphotography.com` (see contact-form-stack.ts).
  </action>
  <verify>
Run `cd infrastructure && npm run build` to verify TypeScript compiles.
Deploy: `export AWS_PROFILE=personal && cd infrastructure && npx cdk deploy CassiePhotoGitHubOidcStack --require-approval never`
  </verify>
  <done>OIDC role has ses:SendEmail permission with FromAddress condition</done>
</task>

<task type="auto">
  <name>Task 2: Add notification steps to deploy workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Modify the workflow to:

1. In the `validate` job, capture Lighthouse scores as outputs:
   - After the Lighthouse step, add a step to parse and output scores
   - Use `$GITHUB_OUTPUT` to expose scores to other jobs

2. In the `deploy` job, add a final success notification step:
   - Runs after CloudFront invalidation
   - Uses AWS CLI to send email via SES
   - Include: site URL, Lighthouse scores from validate job, commit SHA, timestamp

3. Add a new `notify-failure` job:
   - `if: failure()` condition
   - `needs: [validate, deploy]` to run after either fails
   - Send email with: which job failed, link to workflow run, commit SHA, error context

Email format for success:
```
Subject: Deploy Success: cassiecayphotography.com

Deployment completed successfully!

Site: https://cassiecayphotography.com
Commit: {sha} - {message}
Time: {timestamp}

Lighthouse Scores:
- Performance: {score}
- Accessibility: {score}
- Best Practices: {score}
- SEO: {score}

View workflow: {github_run_url}
```

Email format for failure:
```
Subject: Deploy Failed: cassiecayphotography.com

Deployment failed!

Failed job: {job_name}
Commit: {sha} - {message}
Time: {timestamp}

View details: {github_run_url}
```

Recipient: mitchellmeffert@gmail.com (not Cassie - per user requirement)
Sender: no-reply@cassiecayphotography.com

Important: The notify-failure job needs its own AWS credentials step since it may run when deploy job fails.
  </action>
  <verify>
1. Push a test commit and verify workflow runs
2. Check email received within 2 minutes of completion
3. Verify Lighthouse scores appear in success email
4. To test failure notification: temporarily break build (e.g., invalid HTML), push, verify failure email, then revert
  </verify>
  <done>Deploy workflow sends success email with Lighthouse scores, failure email with error context</done>
</task>

</tasks>

<verification>
1. Trigger deploy by pushing a change (or workflow_dispatch)
2. Verify success email arrives at mitchellmeffert@gmail.com within 2 minutes
3. Success email contains:
   - Link to https://cassiecayphotography.com
   - All 4 Lighthouse scores
   - Commit info
4. (Optional) Trigger failure by temporarily breaking build, verify failure email arrives
</verification>

<success_criteria>
- Mitchell receives email when deploy succeeds (with site link and Lighthouse scores)
- Mitchell receives email when deploy fails (with error summary and workflow link)
- Notifications arrive within 2 minutes of deploy completion
- Uses existing SES infrastructure (no new services)
</success_criteria>

<output>
After completion, create `.planning/phases/05-notifications-feedback/05-01-SUMMARY.md`
</output>
