---
phase: 03-image-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - scripts/optimize-images.js
  - images-optimized/
autonomous: true

must_haves:
  truths:
    - "Sharp.js script can convert any JPEG/PNG to AVIF, WebP, and optimized JPEG"
    - "Quality settings are conservative (AVIF 85, WebP 85, JPEG 90) preserving portfolio quality"
    - "PNG transparency is preserved in AVIF and WebP variants"
    - "Original images remain untouched in images/ directory"
  artifacts:
    - path: "scripts/optimize-images.js"
      provides: "Image optimization script"
      exports: ["optimizeImages"]
    - path: "package.json"
      provides: "npm dependencies and preprocess script"
      contains: "sharp"
    - path: "images-optimized/"
      provides: "Optimized image variants directory structure"
  key_links:
    - from: "scripts/optimize-images.js"
      to: "images/"
      via: "glob pattern matching"
      pattern: "images/\\*\\*/*.{jpg,jpeg,png}"
    - from: "package.json"
      to: "scripts/optimize-images.js"
      via: "npm run preprocess"
      pattern: "node scripts/optimize-images.js"
---

<objective>
Create Sharp.js image optimization pipeline with CONSERVATIVE quality settings for photography portfolio

Purpose: Set up the foundation for image format conversion (AVIF/WebP/JPEG) that reduces payload from 81MB while preserving photography quality. This is a professional photography portfolio - quality is paramount.

Output:
- `scripts/optimize-images.js` - Image optimization script
- `images-optimized/` directory with AVIF, WebP, and JPEG subdirectories
- npm scripts for running optimization
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-image-optimization/03-RESEARCH.md

# Current image handling
@vite.config.js

# Understand current image structure
Images are in images/ directory, copied via vite-plugin-static-copy
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sharp.js and dependencies</name>
  <files>package.json</files>
  <action>
Install Sharp.js and supporting dependencies for image optimization:

```bash
npm install --save-dev sharp glob fs-extra cli-progress p-limit
```

Add npm scripts to package.json:
- `preprocess`: `node scripts/optimize-images.js` - runs image optimization
- `prebuild`: `npm run preprocess` - ensures images are optimized before build

Note: Using ES modules (project has "type": "module" in package.json).
  </action>
  <verify>
Run `npm ls sharp` to confirm installation.
Check package.json has both "preprocess" and "prebuild" scripts.
  </verify>
  <done>
Sharp 0.34.x+ installed.
package.json has preprocess and prebuild scripts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create image optimization script with CONSERVATIVE quality</name>
  <files>scripts/optimize-images.js</files>
  <action>
Create `scripts/optimize-images.js` with the following features:

**CRITICAL: Use CONSERVATIVE quality settings (photography portfolio)**
- AVIF: quality 85, effort 6, chromaSubsampling '4:4:4'
- WebP: quality 85, effort 6, smartSubsample true
- JPEG: quality 90, mozjpeg true, progressive true

**Script requirements:**
1. Source: `images/` directory
2. Output: `images-optimized/` with subdirectories: `avif/`, `webp/`, `jpeg/`
3. Process all .jpg, .jpeg, .png files
4. Preserve directory structure (flat - all images in root of each format dir)
5. Preserve filename (change extension only)
6. Handle PNG transparency (AVIF and WebP support alpha)
7. Show progress bar during processing
8. Limit concurrency to 4 (memory management)
9. Skip files that already exist and are newer than source
10. Report total size reduction at end

**PNG handling:**
- Detect if PNG has alpha channel
- If alpha: convert to AVIF/WebP (both support transparency), skip JPEG
- If no alpha: convert to all three formats

**Output structure:**
```
images-optimized/
  avif/
    cassiecay-F1-full.avif
    cassiecay-F1.avif
    ...
  webp/
    cassiecay-F1-full.webp
    cassiecay-F1.webp
    ...
  jpeg/
    cassiecay-F1-full.jpg
    cassiecay-F1.jpg
    ...
```

Use ES module syntax (import/export) since project has "type": "module".
  </action>
  <verify>
File exists at scripts/optimize-images.js
Script imports sharp, glob, fs-extra, cli-progress, p-limit
Quality settings are AVIF 85, WebP 85, JPEG 90
  </verify>
  <done>
scripts/optimize-images.js exists with conservative quality settings.
Handles PNG transparency detection.
Has progress bar and size reporting.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run optimization and verify output</name>
  <files>images-optimized/</files>
  <action>
Run the optimization script:

```bash
npm run preprocess
```

After completion:
1. Verify images-optimized/ directory structure exists with avif/, webp/, jpeg/ subdirs
2. Count files in each subdirectory
3. Calculate and report total size:
   - Original: `du -sh images/`
   - AVIF: `du -sh images-optimized/avif/`
   - WebP: `du -sh images-optimized/webp/`
   - JPEG: `du -sh images-optimized/jpeg/`
4. Verify a few sample images exist in each format

Expected results (from research):
- AVIF: ~40MB (50% reduction)
- WebP: ~57MB (30% reduction)
- JPEG: ~65MB (20% reduction)

The size targets may vary - what matters is quality preservation.
  </action>
  <verify>
`ls images-optimized/avif/ | wc -l` shows ~219 files
`ls images-optimized/webp/ | wc -l` shows ~219 files
`ls images-optimized/jpeg/ | wc -l` shows files (fewer if PNGs with alpha)
`du -sh images-optimized/avif/` shows significant reduction from 81MB
  </verify>
  <done>
All 219 images have AVIF and WebP variants.
JPEG variants exist for non-transparent images.
Size reduction achieved (exact amount may vary with conservative settings).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run preprocess` completes without errors
2. images-optimized/ contains avif/, webp/, jpeg/ subdirectories
3. Each subdirectory contains converted images
4. Script reports size reduction
5. Original images/ directory unchanged (81MB)
</verification>

<success_criteria>
1. Sharp.js script exists at scripts/optimize-images.js
2. Quality settings are conservative (AVIF 85, WebP 85, JPEG 90)
3. All 219 images have AVIF and WebP variants
4. npm run preprocess works and reports completion
5. Total optimized image size is significantly less than 81MB original
</success_criteria>

<output>
After completion, create `.planning/phases/03-image-optimization/03-01-SUMMARY.md`
</output>
