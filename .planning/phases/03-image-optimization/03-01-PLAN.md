---
phase: 03-image-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - scripts/optimize-images.js
  - images-optimized/
autonomous: true

must_haves:
  truths:
    - "Sharp.js script can convert any JPEG/PNG to AVIF, WebP, and optimized JPEG"
    - "Script generates responsive width variants (800w, 1200w, 1800w) for each format"
    - "Quality settings are conservative (AVIF 85, WebP 85, JPEG 90) preserving portfolio quality"
    - "PNG transparency is preserved in AVIF and WebP variants"
    - "Original images remain untouched in images/ directory"
  artifacts:
    - path: "scripts/optimize-images.js"
      provides: "Image optimization script with responsive variants"
      exports: ["optimizeImages"]
    - path: "package.json"
      provides: "npm dependencies and preprocess script"
      contains: "sharp"
    - path: "images-optimized/"
      provides: "Optimized image variants directory structure with width subdirs"
  key_links:
    - from: "scripts/optimize-images.js"
      to: "images/"
      via: "glob pattern matching"
      pattern: "images/\\*\\*/*.{jpg,jpeg,png}"
    - from: "package.json"
      to: "scripts/optimize-images.js"
      via: "npm run preprocess"
      pattern: "node scripts/optimize-images.js"
---

<objective>
Create Sharp.js image optimization pipeline with CONSERVATIVE quality settings and RESPONSIVE WIDTH VARIANTS for photography portfolio

Purpose: Set up the foundation for image format conversion (AVIF/WebP/JPEG) with responsive sizing (800w, 1200w, 1800w) to achieve 60%+ payload reduction from 81MB while preserving photography quality. Responsive variants are critical - format conversion alone achieves only ~50% reduction.

Output:
- `scripts/optimize-images.js` - Image optimization script with responsive variants
- `images-optimized/` directory with format and width subdirectories
- npm scripts for running optimization
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/roadmap/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-image-optimization/03-RESEARCH.md

# Current image handling
@vite.config.js

# Understand current image structure
Images are in images/ directory, copied via vite-plugin-static-copy
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sharp.js and dependencies</name>
  <files>package.json</files>
  <action>
Install Sharp.js and supporting dependencies for image optimization:

```bash
npm install --save-dev sharp glob fs-extra cli-progress p-limit
```

Add npm scripts to package.json:
- `preprocess`: `node scripts/optimize-images.js` - runs image optimization
- `prebuild`: `npm run preprocess` - ensures images are optimized before build

Note: Using ES modules (project has "type": "module" in package.json).
  </action>
  <verify>
Run `npm ls sharp` to confirm installation.
Check package.json has both "preprocess" and "prebuild" scripts.
  </verify>
  <done>
Sharp 0.34.x+ installed.
package.json has preprocess and prebuild scripts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create image optimization script with responsive variants</name>
  <files>scripts/optimize-images.js</files>
  <action>
Create `scripts/optimize-images.js` with the following features:

**CRITICAL: Use CONSERVATIVE quality settings (photography portfolio)**
- AVIF: quality 85, effort 6, chromaSubsampling '4:4:4'
- WebP: quality 85, effort 6, smartSubsample true
- JPEG: quality 90, mozjpeg true, progressive true

**CRITICAL: Generate RESPONSIVE WIDTH VARIANTS**
For each source image, generate 4 width variants:
- `full/` - original dimensions (for lightbox)
- `1800w/` - max-width 1800px (large screens)
- `1200w/` - max-width 1200px (medium screens)
- `800w/` - max-width 800px (small screens, thumbnails)

Only downscale - if source is smaller than target width, skip that variant.
Maintain aspect ratio when resizing.

**Output directory structure:**
```
images-optimized/
  avif/
    full/
      cassiecay-F1-full.avif
      cassiecay-F1.avif
    1800w/
      cassiecay-F1-full.avif
      cassiecay-F1.avif
    1200w/
      cassiecay-F1-full.avif
      cassiecay-F1.avif
    800w/
      cassiecay-F1-full.avif
      cassiecay-F1.avif
  webp/
    full/
    1800w/
    1200w/
    800w/
  jpeg/
    full/
    1800w/
    1200w/
    800w/
```

**Script requirements:**
1. Source: `images/` directory
2. Output: `images-optimized/` with format and width subdirectories
3. Process all .jpg, .jpeg, .png files
4. Preserve filename (change extension only)
5. Handle PNG transparency (AVIF and WebP support alpha)
6. Show progress bar during processing
7. Limit concurrency to 4 (memory management)
8. Skip files that already exist and are newer than source
9. Report total size reduction at end
10. Report breakdown by format AND by width variant

**PNG handling:**
- Detect if PNG has alpha channel
- If alpha: convert to AVIF/WebP (both support transparency), skip JPEG
- If no alpha: convert to all three formats

**Why responsive variants matter:**
- Format conversion alone: 81MB -> ~40MB (50% reduction)
- Format + responsive: 81MB -> ~25MB (70% reduction)
- Most gallery thumbnails display at 400-600px, serving 1800px images wastes bandwidth

Use ES module syntax (import/export) since project has "type": "module".
  </action>
  <verify>
File exists at scripts/optimize-images.js
Script imports sharp, glob, fs-extra, cli-progress, p-limit
Quality settings are AVIF 85, WebP 85, JPEG 90
Script generates full/, 1800w/, 1200w/, 800w/ subdirectories
  </verify>
  <done>
scripts/optimize-images.js exists with conservative quality settings.
Generates responsive width variants (full, 1800w, 1200w, 800w).
Handles PNG transparency detection.
Has progress bar and size reporting.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run optimization and verify output</name>
  <files>images-optimized/</files>
  <action>
Run the optimization script:

```bash
npm run preprocess
```

After completion:
1. Verify images-optimized/ directory structure exists with format and width subdirs
2. Count files in key subdirectories:
   - `ls images-optimized/avif/full/ | wc -l` (should be ~219)
   - `ls images-optimized/avif/800w/ | wc -l` (should be ~219 or fewer)
3. Calculate and report total size:
   - Original: `du -sh images/`
   - Full AVIF: `du -sh images-optimized/avif/full/`
   - 800w AVIF: `du -sh images-optimized/avif/800w/`
   - Total optimized: `du -sh images-optimized/`
4. Verify responsive variants exist for a sample image

**Expected results with responsive variants:**
- AVIF full: ~40MB
- AVIF 1800w: ~25MB
- AVIF 1200w: ~15MB
- AVIF 800w: ~8MB
- Using 800w for thumbnails + full for lightbox achieves 60%+ reduction

**Size target:** Total served payload < 32MB (60% reduction from 81MB)
The 800w variants for gallery display + full variants for lightbox should meet this.
  </action>
  <verify>
`ls images-optimized/avif/full/ | wc -l` shows ~219 files
`ls images-optimized/avif/800w/ | wc -l` shows files (some may be skipped if source < 800px)
`du -sh images-optimized/avif/800w/` shows significant reduction from full variants
Directory structure has format/width nesting
  </verify>
  <done>
All 219 images have AVIF and WebP variants at multiple widths.
JPEG variants exist for non-transparent images.
800w variants provide significant size reduction for gallery thumbnails.
Total optimized directory exists with complete structure.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run preprocess` completes without errors
2. images-optimized/ contains avif/, webp/, jpeg/ subdirectories
3. Each format directory contains full/, 1800w/, 1200w/, 800w/ subdirectories
4. Script reports size reduction by format and width
5. Original images/ directory unchanged (81MB)
6. 800w variants provide at least 70% reduction vs full variants
</verification>

<success_criteria>
1. Sharp.js script exists at scripts/optimize-images.js
2. Quality settings are conservative (AVIF 85, WebP 85, JPEG 90)
3. All 219 images have AVIF and WebP variants at 4 widths each
4. npm run preprocess works and reports completion
5. 800w variants enable 60%+ total payload reduction target
</success_criteria>

<output>
After completion, create `.planning/phases/03-image-optimization/03-01-SUMMARY.md`
</output>
