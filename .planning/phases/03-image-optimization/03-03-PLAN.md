---
phase: 03-image-optimization
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - index.html
  - vite.config.js
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "All portfolio images use <picture> elements with AVIF, WebP, JPEG fallback"
    - "Gallery thumbnails use srcset with responsive widths (800w, 1200w, 1800w)"
    - "Lightbox opens full-size optimized JPEG images"
    - "Below-fold images have loading='lazy' attribute"
    - "Above-fold images (hero slider, logo) do NOT have lazy loading"
    - "Portfolio gallery displays correctly with visible images"
  artifacts:
    - path: "index.html"
      provides: "Updated HTML with picture elements and srcset"
      contains: "<picture>"
    - path: "vite.config.js"
      provides: "Updated to copy optimized images"
      contains: "images-optimized"
    - path: "dist/images-optimized/"
      provides: "Built optimized images"
  key_links:
    - from: "index.html"
      to: "images-optimized/"
      via: "picture source srcset"
      pattern: "images-optimized/avif/"
    - from: "vite.config.js"
      to: "images-optimized/"
      via: "viteStaticCopy"
      pattern: "src: 'images-optimized'"
---

<objective>
Update HTML to serve optimized images with modern format support, responsive sizing, and fallbacks

Purpose: Wire the optimized images into the site HTML using `<picture>` elements with `srcset` for responsive width selection. Browsers will automatically receive AVIF (best compression) at the appropriate size, with WebP and JPEG fallbacks for older browsers.

Output:
- Updated index.html with `<picture>` elements and responsive srcset
- Updated vite.config.js to copy optimized images
- Working build with optimized images achieving 60%+ payload reduction
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/roadmap/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-image-optimization/03-RESEARCH.md
@.planning/phases/03-image-optimization/03-01-SUMMARY.md
@.planning/phases/03-image-optimization/03-02-SUMMARY.md

# Current file structure
@index.html
@vite.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update vite.config.js to copy optimized images</name>
  <files>vite.config.js</files>
  <action>
Update vite.config.js to:

1. Replace the images/ copy target with images-optimized/:
```javascript
// Change this:
{
  src: 'images',
  dest: '.'
}
// To this:
{
  src: 'images-optimized',
  dest: '.'
}
```

2. ALSO keep original images for any references not yet migrated (safety):
```javascript
{
  src: 'images',
  dest: '.'
},
{
  src: 'images-optimized',
  dest: '.'
}
```

This ensures both directories are available in the build output during migration.

Note: Keep all other copy targets unchanged (Revolution Slider, CSS, JS, etc.)
  </action>
  <verify>
vite.config.js includes both images and images-optimized in copy targets.
`npm run build` completes successfully.
`ls dist/images-optimized/avif/800w/ | head -5` shows AVIF files copied.
  </verify>
  <done>
vite.config.js updated to copy both images/ and images-optimized/ directories.
Build includes optimized image directories with all width variants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.html gallery images to use picture elements with srcset</name>
  <files>index.html</files>
  <action>
Update all portfolio gallery images (in the #portfolio section) to use `<picture>` elements with responsive srcset.

**Current pattern:**
```html
<figure class="overlay overlay2">
  <a href="images/cassiecay-F1-full.png">
    <img src="images/cassiecay-F1.png" alt="" loading="lazy" />
  </a>
</figure>
```

**New pattern (with responsive srcset):**
```html
<figure class="overlay overlay2">
  <a href="images-optimized/jpeg/full/cassiecay-F1-full.jpg">
    <picture>
      <source
        srcset="images-optimized/avif/800w/cassiecay-F1.avif 800w,
                images-optimized/avif/1200w/cassiecay-F1.avif 1200w,
                images-optimized/avif/1800w/cassiecay-F1.avif 1800w"
        sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px"
        type="image/avif">
      <source
        srcset="images-optimized/webp/800w/cassiecay-F1.webp 800w,
                images-optimized/webp/1200w/cassiecay-F1.webp 1200w,
                images-optimized/webp/1800w/cassiecay-F1.webp 1800w"
        sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px"
        type="image/webp">
      <img
        src="images-optimized/jpeg/800w/cassiecay-F1.jpg"
        srcset="images-optimized/jpeg/800w/cassiecay-F1.jpg 800w,
                images-optimized/jpeg/1200w/cassiecay-F1.jpg 1200w,
                images-optimized/jpeg/1800w/cassiecay-F1.jpg 1800w"
        sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 400px"
        alt=""
        loading="lazy">
    </picture>
  </a>
</figure>
```

**Key decisions:**
1. **Lightbox uses JPEG only**: The `href` points directly to full-size JPEG. This is simpler and avoids needing JS format detection. The lightbox already works, and JPEG has universal support. This is a known limitation - lightbox doesn't get AVIF benefits, but gallery thumbnails (the majority of loaded images) do.

2. **Responsive srcset**: Gallery thumbnails use srcset with 800w, 1200w, 1800w breakpoints. Browser selects appropriate size based on viewport.

3. **sizes attribute**: Tells browser how large the image will display:
   - Mobile (< 600px): full viewport width
   - Tablet (< 1200px): half viewport width
   - Desktop: ~400px (fixed gallery grid size)

4. **No data-avif/data-webp attributes**: Removed - lightbox stays JPEG-only.

**Rules:**
1. Thumbnail `<img>` becomes `<picture>` with srcset for each format
2. Lightbox href points to `images-optimized/jpeg/full/` (JPEG fallback, full size)
3. Keep loading="lazy" on the `<img>` element inside picture
4. Keep existing alt text (even if empty)
5. Handle both .png and .jpg source images - all become .avif/.webp/.jpg outputs

**Special cases:**
- Images with transparency (detected by PNG extension and alpha): Use WebP as the img src fallback since JPEG doesn't support transparency
- If jpeg/ doesn't have a file for a given image, use webp/ as the fallback

**Images to update (all in #cube-grid-mosaic div):**
All `<figure class="overlay overlay2">` elements in the portfolio section.

Count: There should be approximately 80+ gallery images to update.
  </action>
  <verify>
`grep -c '<picture>' index.html` shows 80+ picture elements
`grep -c 'srcset=' index.html` shows multiple srcset attributes
`grep -c 'images-optimized/avif' index.html` shows AVIF references
All portfolio images use new path structure with responsive widths
No `data-avif` or `data-webp` attributes present (lightbox is JPEG-only)
  </verify>
  <done>
All portfolio gallery images converted to picture elements with responsive srcset.
AVIF/WebP/JPEG format fallback chain implemented with width variants.
Lightbox links point to full-size optimized JPEG images.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update remaining images (about, services, backgrounds, slider, logos)</name>
  <files>index.html</files>
  <action>
Update non-gallery images in index.html:

**1. About section image:**
```html
<!-- Current -->
<img src="images/cassiecay-aboutbw.jpg" alt="" loading="lazy" />
<!-- New -->
<picture>
  <source srcset="images-optimized/avif/800w/cassiecay-aboutbw.avif" type="image/avif">
  <source srcset="images-optimized/webp/800w/cassiecay-aboutbw.webp" type="image/webp">
  <img src="images-optimized/jpeg/800w/cassiecay-aboutbw.jpg" alt="" loading="lazy">
</picture>
```
About image displays at fixed size, no srcset needed.

**2. Service section octagon images (8 images):**
Same pattern, add picture elements. Keep loading behavior as-is.

**3. Background images (data-image-src attribute):**
These are CSS backgrounds, not `<img>` tags. For now, point to JPEG versions:
```html
<!-- Current -->
data-image-src="images/cassiecay-background1.jpg"
<!-- New -->
data-image-src="images-optimized/jpeg/1800w/cassiecay-background1.jpg"
```
Note: Full CSS background format negotiation is complex and not critical for this phase.

**4. Logo images:**
```html
<!-- Current -->
<img src="images/cassiecaylogobw2.png" srcset="images/cassiecaylogobw2.png 1x, images/cassiecaylogobw2.png 2x" alt="Cassie Cay Photography logo" />
<!-- New -->
<picture>
  <source srcset="images-optimized/avif/800w/cassiecaylogobw2.avif" type="image/avif">
  <source srcset="images-optimized/webp/800w/cassiecaylogobw2.webp" type="image/webp">
  <img src="images-optimized/jpeg/800w/cassiecaylogobw2.jpg" alt="Cassie Cay Photography logo">
</picture>
```
Note: Remove srcset since picture handles format selection. Logo is small, doesn't need resolution variants.

**5. Hero slider images - DO NOT lazy load:**
```html
<!-- Current -->
<img src="images/cassiecay-slider7.jpg" alt="Cassie Cay Photography" />
<!-- New - NO loading="lazy" (above fold), use 1800w for hero -->
<picture>
  <source srcset="images-optimized/avif/1800w/cassiecay-slider7.avif" type="image/avif">
  <source srcset="images-optimized/webp/1800w/cassiecay-slider7.webp" type="image/webp">
  <img src="images-optimized/jpeg/1800w/cassiecay-slider7.jpg" alt="Cassie Cay Photography">
</picture>
```
Same for cassiecay-slider2.jpg. Do NOT add loading="lazy" to these - they're above the fold.
Use 1800w variant since hero displays at large size.

**6. Booking button image:**
```html
<img src="images/BookaPhotoshoot.png" alt="" width="200" border="0" />
```
This is a small UI element. Convert to picture with AVIF/WebP/PNG fallback (or WebP fallback if PNG has transparency).

**7. Favicon:**
Leave favicon.ico unchanged (browsers expect .ico format).
  </action>
  <verify>
All img tags (except favicon) now use picture elements or updated paths.
Hero slider images do NOT have loading="lazy".
Background data-image-src attributes point to images-optimized/jpeg/1800w/.
`grep -c 'src="images/' index.html` should show only favicon.ico reference.

**VERIFY SLIDER OPERATION:**
Run `npm run preview` and visually confirm:
1. Hero slider loads and animates (auto-advance still works)
2. Slider pause-on-hover behavior works (if applicable)
3. No console errors related to slider images
4. All slider images display at correct dimensions
  </verify>
  <done>
All non-gallery images converted to picture elements.
Background images point to optimized JPEG versions (1800w).
Hero slider images preserved without lazy loading, uses 1800w variants.
Revolution Slider continues to function with optimized images.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
```bash
npm run build
```
Should complete without errors.

2. File structure verification:
```bash
ls dist/images-optimized/avif/800w/ | wc -l  # Should show ~219 files
ls dist/images-optimized/avif/full/ | wc -l  # Should show ~219 files
```

3. HTML verification:
```bash
grep -c '<picture>' dist/index.html  # Should show 90+ picture elements
grep -c 'srcset=' dist/index.html    # Should show srcset attributes
grep 'data-avif' dist/index.html     # Should return nothing (lightbox is JPEG-only)
```

4. Size verification (THE 60% TARGET):
```bash
# Calculate total size of images that will actually be served for initial page load
# Gallery uses 800w, lightbox uses full (on-demand), hero uses 1800w
du -sh dist/images-optimized/avif/800w/   # Gallery thumbnails
du -sh dist/images-optimized/avif/1800w/  # Hero images
# Total initial load should be < 32MB (60% of 81MB)
```

5. Serve and visual test:
```bash
npm run preview
```
Open http://localhost:4173 and verify:
- Hero slider loads, animates, and transitions correctly
- Portfolio gallery images display at correct sizes
- Lightbox opens and shows full-size images (JPEG)
- About section image displays
- Service section images display
- No console errors
</verification>

<success_criteria>
1. All portfolio images use `<picture>` elements with responsive srcset
2. `npm run build` completes successfully
3. dist/ contains images-optimized/ with all format and width variants
4. Hero slider images load immediately (no lazy loading) and slider functions correctly
5. Gallery images have loading="lazy" attribute
6. Site renders correctly when served via `npm run preview`
7. Initial page load uses 800w gallery images, achieving 60%+ payload reduction
8. Lightbox uses full-size JPEG (known limitation, documented)
</success_criteria>

<output>
After completion, create `.planning/phases/03-image-optimization/03-03-SUMMARY.md`

Include:
- Final file size comparison (original vs optimized served payload)
- Verification that 60% reduction target is met
- Count of picture elements added
- Confirmation that Revolution Slider works with optimized images
- Note: Lightbox uses JPEG-only (known limitation)
</output>
