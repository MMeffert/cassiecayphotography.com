---
phase: 03-image-optimization
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - index.html
  - vite.config.js
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "All portfolio images use <picture> elements with AVIF, WebP, JPEG fallback"
    - "Lightbox links point to optimized full-size images with format fallback"
    - "Below-fold images have loading='lazy' attribute"
    - "Above-fold images (hero slider, logo) do NOT have lazy loading"
    - "Site builds successfully and images display correctly"
  artifacts:
    - path: "index.html"
      provides: "Updated HTML with picture elements"
      contains: "<picture>"
    - path: "vite.config.js"
      provides: "Updated to copy optimized images"
      contains: "images-optimized"
    - path: "dist/images-optimized/"
      provides: "Built optimized images"
  key_links:
    - from: "index.html"
      to: "images-optimized/"
      via: "picture source srcset"
      pattern: "images-optimized/avif/"
    - from: "vite.config.js"
      to: "images-optimized/"
      via: "viteStaticCopy"
      pattern: "src: 'images-optimized'"
---

<objective>
Update HTML to serve optimized images with modern format support and fallbacks

Purpose: Wire the optimized images into the site HTML using `<picture>` elements for format negotiation. Browsers will automatically receive AVIF (best compression) with WebP and JPEG fallbacks for older browsers.

Output:
- Updated index.html with `<picture>` elements
- Updated vite.config.js to copy optimized images
- Working build with optimized images
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-image-optimization/03-RESEARCH.md
@.planning/phases/03-image-optimization/03-01-SUMMARY.md
@.planning/phases/03-image-optimization/03-02-SUMMARY.md

# Current file structure
@index.html
@vite.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update vite.config.js to copy optimized images</name>
  <files>vite.config.js</files>
  <action>
Update vite.config.js to:

1. Replace the images/ copy target with images-optimized/:
```javascript
// Change this:
{
  src: 'images',
  dest: '.'
}
// To this:
{
  src: 'images-optimized',
  dest: '.'
}
```

2. ALSO keep original images for any references not yet migrated (safety):
```javascript
{
  src: 'images',
  dest: '.'
},
{
  src: 'images-optimized',
  dest: '.'
}
```

This ensures both directories are available in the build output during migration.

Note: Keep all other copy targets unchanged (Revolution Slider, CSS, JS, etc.)
  </action>
  <verify>
vite.config.js includes both images and images-optimized in copy targets.
`npm run build` completes successfully.
`ls dist/images-optimized/avif/ | head -5` shows AVIF files copied.
  </verify>
  <done>
vite.config.js updated to copy both images/ and images-optimized/ directories.
Build includes optimized image directories.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.html gallery images to use picture elements</name>
  <files>index.html</files>
  <action>
Update all portfolio gallery images (in the #portfolio section) to use `<picture>` elements.

**Current pattern:**
```html
<figure class="overlay overlay2">
  <a href="images/cassiecay-F1-full.png">
    <img src="images/cassiecay-F1.png" alt="" loading="lazy" />
  </a>
</figure>
```

**New pattern:**
```html
<figure class="overlay overlay2">
  <a href="images-optimized/jpeg/cassiecay-F1-full.jpg"
     data-avif="images-optimized/avif/cassiecay-F1-full.avif"
     data-webp="images-optimized/webp/cassiecay-F1-full.webp">
    <picture>
      <source srcset="images-optimized/avif/cassiecay-F1.avif" type="image/avif">
      <source srcset="images-optimized/webp/cassiecay-F1.webp" type="image/webp">
      <img src="images-optimized/jpeg/cassiecay-F1.jpg" alt="" loading="lazy">
    </picture>
  </a>
</figure>
```

**Rules:**
1. Thumbnail `<img>` becomes `<picture>` with AVIF, WebP, JPEG sources
2. Lightbox href points to JPEG fallback (most compatible)
3. Add data-avif and data-webp attributes for potential lightbox enhancement
4. Keep loading="lazy" on the `<img>` element inside picture
5. Keep existing alt text (even if empty)
6. Handle both .png and .jpg source images - all become .avif/.webp/.jpg outputs

**Special cases:**
- Images with transparency (detected by PNG extension and alpha in optimized output): These will only have AVIF and WebP versions, not JPEG. Use WebP as fallback since JPEG doesn't support transparency.
- If jpeg/ doesn't have a file for a given image, use webp/ as the img src fallback

**Images to update (all in #cube-grid-mosaic div):**
All `<figure class="overlay overlay2">` elements in the portfolio section.

Count: There should be approximately 80+ gallery images to update.
  </action>
  <verify>
`grep -c '<picture>' index.html` shows 80+ picture elements
`grep -c 'images-optimized/avif' index.html` shows AVIF references
All portfolio images use new path structure
  </verify>
  <done>
All portfolio gallery images converted to picture elements.
AVIF/WebP/JPEG format fallback chain implemented.
Lightbox links point to optimized images.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update remaining images (about, services, backgrounds, logos)</name>
  <files>index.html</files>
  <action>
Update non-gallery images in index.html:

**1. About section image:**
```html
<!-- Current -->
<img src="images/cassiecay-aboutbw.jpg" alt="" loading="lazy" />
<!-- New -->
<picture>
  <source srcset="images-optimized/avif/cassiecay-aboutbw.avif" type="image/avif">
  <source srcset="images-optimized/webp/cassiecay-aboutbw.webp" type="image/webp">
  <img src="images-optimized/jpeg/cassiecay-aboutbw.jpg" alt="" loading="lazy">
</picture>
```

**2. Service section octagon images (8 images):**
Same pattern, add picture elements. Keep loading behavior as-is.

**3. Background images (data-image-src attribute):**
These are CSS backgrounds, not `<img>` tags. For now, point to JPEG versions:
```html
<!-- Current -->
data-image-src="images/cassiecay-background1.jpg"
<!-- New -->
data-image-src="images-optimized/jpeg/cassiecay-background1.jpg"
```
Note: Full CSS background format negotiation is complex and not critical for this phase.

**4. Logo images:**
```html
<!-- Current -->
<img src="images/cassiecaylogobw2.png" srcset="images/cassiecaylogobw2.png 1x, images/cassiecaylogobw2.png 2x" alt="Cassie Cay Photography logo" />
<!-- New -->
<picture>
  <source srcset="images-optimized/avif/cassiecaylogobw2.avif" type="image/avif">
  <source srcset="images-optimized/webp/cassiecaylogobw2.webp" type="image/webp">
  <img src="images-optimized/jpeg/cassiecaylogobw2.jpg" alt="Cassie Cay Photography logo">
</picture>
```
Note: Remove srcset since picture handles format selection. Logo is small, doesn't need resolution variants.

**5. Hero slider images - DO NOT lazy load:**
```html
<!-- Current -->
<img src="images/cassiecay-slider7.jpg" alt="Cassie Cay Photography" />
<!-- New - NO loading="lazy" (above fold) -->
<picture>
  <source srcset="images-optimized/avif/cassiecay-slider7.avif" type="image/avif">
  <source srcset="images-optimized/webp/cassiecay-slider7.webp" type="image/webp">
  <img src="images-optimized/jpeg/cassiecay-slider7.jpg" alt="Cassie Cay Photography">
</picture>
```
Same for cassiecay-slider2.jpg. Do NOT add loading="lazy" to these - they're above the fold.

**6. Booking button image:**
```html
<img src="images/BookaPhotoshoot.png" alt="" width="200" border="0" />
```
This is a small UI element. Convert to picture with AVIF/WebP/PNG fallback (or WebP fallback if PNG has transparency).

**7. Favicon:**
Leave favicon.ico unchanged (browsers expect .ico format).
  </action>
  <verify>
All img tags (except favicon) now use picture elements or updated paths.
Hero slider images do NOT have loading="lazy".
Background data-image-src attributes point to images-optimized/jpeg/.
`grep -c 'src="images/' index.html` should show only favicon.ico reference.
  </verify>
  <done>
All non-gallery images converted to picture elements.
Background images point to optimized JPEG versions.
Hero slider images preserved without lazy loading.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
```bash
npm run build
```
Should complete without errors.

2. File structure verification:
```bash
ls dist/images-optimized/avif/ | wc -l  # Should show ~219 files
ls dist/images-optimized/webp/ | wc -l  # Should show ~219 files
```

3. HTML verification:
```bash
grep -c '<picture>' dist/index.html  # Should show 90+ picture elements
grep 'images/cassiecay' dist/index.html  # Should only show favicon or none
```

4. Serve and visual test:
```bash
npm run preview
```
Open http://localhost:4173 and verify:
- Hero slider loads and displays
- Portfolio gallery images display
- Lightbox opens and shows full images
- About section image displays
- Service section images display
</verification>

<success_criteria>
1. All portfolio images use `<picture>` elements with AVIF/WebP/JPEG sources
2. `npm run build` completes successfully
3. dist/ contains images-optimized/ with all format variants
4. Hero slider images load immediately (no lazy loading)
5. Gallery images have loading="lazy" attribute
6. Site renders correctly when served via `npm run preview`
</success_criteria>

<output>
After completion, create `.planning/phases/03-image-optimization/03-03-SUMMARY.md`

Include:
- Final file size comparison (original vs optimized)
- Count of picture elements added
- Verification that site renders correctly
</output>
