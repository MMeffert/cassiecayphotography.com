---
phase: 18-image-sitemap
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [package.json, scripts/generate-sitemap.js, sitemap.xml]
autonomous: true

must_haves:
  truths:
    - "npm run build generates image-sitemap.xml in dist/"
    - "image-sitemap.xml contains all portfolio images with captions"
    - "Each image has geo_location tag with Madison, WI"
    - "Main sitemap.xml is sitemap index format referencing image sitemap"
  artifacts:
    - path: "scripts/generate-sitemap.js"
      provides: "Build-time sitemap generation"
      exports: ["generateSitemap"]
      min_lines: 80
    - path: "dist/image-sitemap.xml"
      provides: "Google Image sitemap"
      contains: ["image:image", "image:caption", "image:geo_location"]
    - path: "dist/sitemap.xml"
      provides: "Sitemap index"
      contains: ["sitemapindex", "image-sitemap.xml"]
  key_links:
    - from: "package.json postbuild"
      to: "scripts/generate-sitemap.js"
      via: "npm script"
      pattern: "postbuild.*generate-sitemap"
    - from: "scripts/generate-sitemap.js"
      to: "dist/*.xml"
      via: "file writes"
      pattern: "writeFileSync.*sitemap"
---

<objective>
Generate image sitemap at build time so Google Image Search can discover all portfolio images.

Purpose: Google Image Search only indexes images it can discover. A dedicated image sitemap with captions and location metadata improves image search visibility for local photography queries like "Madison family photographer".

Output: Build process generates image-sitemap.xml and updates main sitemap.xml to sitemap index format.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
@sitemap.xml
@scripts/optimize-images.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sitemap generation script</name>
  <files>package.json, scripts/generate-sitemap.js</files>
  <action>
**Step 1: Install sitemap package**

```bash
npm install --save-dev sitemap@9
```

**Step 2: Create scripts/generate-sitemap.js**

Create a Node.js ESM script that:

1. **Discovers portfolio images** by scanning `dist/images-optimized/jpeg/full/` for files matching pattern `cassiecay-[BCEFGSW][0-9]+*.jpg`. These are the portfolio images (Family, Bridal, Corporate, Event, Senior, Wedding categories).

2. **Generates image-sitemap.xml** using the `sitemap` package with Google's image extension namespace:
   - Each portfolio image gets an `<image:image>` entry
   - Include `<image:loc>` with absolute URL
   - Include `<image:caption>` derived from filename (e.g., "cassiecay-F1-full.jpg" -> "Family portrait photography by Cassie Cay Photography")
   - Include `<image:geo_location>` set to "Madison, Wisconsin, USA"

3. **Generates sitemap index** (main sitemap.xml):
   - Create sitemap index format with `<sitemapindex>` root
   - Reference the main page sitemap (inline or separate)
   - Reference image-sitemap.xml
   - Include `<lastmod>` timestamps

**Caption generation logic:**
Map filename prefix to category:
- `cassiecay-F` -> "Family portrait"
- `cassiecay-B` -> "Bridal portrait"
- `cassiecay-C` -> "Corporate portrait"
- `cassiecay-E` -> "Event"
- `cassiecay-S` -> "Senior portrait"
- `cassiecay-W` -> "Wedding"
- `cassiecay-NB` -> "Newborn"
- `cassiecay-M` -> "Milestone"
- `cassiecay-senior` -> "Senior portrait"
- Default -> "Professional portrait"

Append " photography by Cassie Cay Photography in Madison, WI" to each caption.

**Script structure:**

```javascript
import { SitemapStream, streamToPromise } from 'sitemap';
import { createWriteStream, readdirSync, writeFileSync } from 'fs';
import { resolve, basename } from 'path';

const SITE_URL = 'https://cassiecayphotography.com';
const DIST_DIR = 'dist';
const GEO_LOCATION = 'Madison, Wisconsin, USA';

// Category mapping from filename prefix
const CATEGORY_MAP = {
  'F': 'Family portrait',
  'B': 'Bridal portrait',
  'C': 'Corporate portrait',
  'E': 'Event',
  'S': 'Senior portrait',
  'W': 'Wedding',
  'NB': 'Newborn',
  'M': 'Milestone',
  'senior': 'Senior portrait'
};

function getCaptionFromFilename(filename) {
  // Extract category from filename like cassiecay-F1-full.jpg
  // ... implementation
}

async function generateImageSitemap() {
  // 1. Scan dist/images-optimized/jpeg/full/ for portfolio images
  // 2. Build image entries with caption and geo_location
  // 3. Write image-sitemap.xml
}

function generateSitemapIndex() {
  // Create sitemap index XML referencing:
  // - Homepage entry (or page-sitemap.xml)
  // - image-sitemap.xml
}

async function generateSitemap() {
  await generateImageSitemap();
  generateSitemapIndex();
}

generateSitemap();
```

**Important implementation notes:**
- Use ESM syntax (import/export) - project has `"type": "module"`
- Output to `dist/` directory (Vite build output)
- Use absolute URLs throughout (https://cassiecayphotography.com/...)
- Match the code style of scripts/optimize-images.js
- Handle case where dist/ doesn't exist yet (create it)
- Filter to only portfolio images (cassiecay-[BCEFGSW], cassiecay-NB, cassiecay-M, cassiecay-senior patterns)
- Exclude non-portfolio images (logos, backgrounds, about photos)

**Step 3: Add postbuild script to package.json**

Add to scripts section:
```json
"generate:sitemap": "node scripts/generate-sitemap.js",
"postbuild": "npm run generate:sitemap"
```

This hooks into Vite's build lifecycle - runs after `vite build` completes.
  </action>
  <verify>
1. `npm install` completes without errors
2. `ls node_modules/sitemap` confirms package installed
3. `node scripts/generate-sitemap.js` runs without errors (may warn about missing dist/ - that's OK)
4. `npm run build` completes and generates dist/image-sitemap.xml and dist/sitemap.xml
5. `grep -c "image:image" dist/image-sitemap.xml` returns count > 80
6. `grep "geo_location" dist/image-sitemap.xml | head -1` shows "Madison, Wisconsin, USA"
7. `grep "sitemapindex" dist/sitemap.xml` confirms sitemap index format
  </verify>
  <done>
- sitemap package (v9.x) installed as devDependency
- scripts/generate-sitemap.js exists and runs without errors
- package.json has postbuild hook calling generate-sitemap
- npm run build produces dist/image-sitemap.xml with 80+ image entries
- Each image has caption and geo_location
- dist/sitemap.xml is sitemap index format
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate sitemap output</name>
  <files>dist/image-sitemap.xml, dist/sitemap.xml</files>
  <action>
Run a full build and validate the generated sitemaps:

```bash
npm run build
```

**Validation checks:**

1. **Image sitemap structure:**
```bash
# Count image entries (should be 80+)
grep -c "<image:image>" dist/image-sitemap.xml

# Verify geo_location present
grep "<image:geo_location>" dist/image-sitemap.xml | head -3

# Verify captions have meaningful content (not just filenames)
grep "<image:caption>" dist/image-sitemap.xml | head -5

# Verify absolute URLs
grep "<image:loc>" dist/image-sitemap.xml | head -3
```

2. **Sitemap index structure:**
```bash
# Verify sitemap index format
head -10 dist/sitemap.xml

# Should contain sitemapindex root and reference to image-sitemap.xml
grep "image-sitemap.xml" dist/sitemap.xml
```

3. **XML validity:**
```bash
# Basic XML syntax check (if xmllint available)
xmllint --noout dist/image-sitemap.xml 2>&1 || echo "xmllint not installed - skip"
xmllint --noout dist/sitemap.xml 2>&1 || echo "xmllint not installed - skip"
```

**Expected output format for image-sitemap.xml:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">
  <url>
    <loc>https://cassiecayphotography.com/</loc>
    <image:image>
      <image:loc>https://cassiecayphotography.com/images-optimized/jpeg/full/cassiecay-F1-full.jpg</image:loc>
      <image:caption>Family portrait photography by Cassie Cay Photography in Madison, WI</image:caption>
      <image:geo_location>Madison, Wisconsin, USA</image:geo_location>
    </image:image>
    <!-- more images -->
  </url>
</urlset>
```

**Expected output format for sitemap.xml:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <sitemap>
    <loc>https://cassiecayphotography.com/sitemap.xml</loc>
    <lastmod>2026-01-21</lastmod>
  </sitemap>
  <sitemap>
    <loc>https://cassiecayphotography.com/image-sitemap.xml</loc>
    <lastmod>2026-01-21</lastmod>
  </sitemap>
</sitemapindex>
```

If validation fails, fix the script and re-run build until all checks pass.
  </action>
  <verify>
1. `npm run build` exits with code 0
2. dist/image-sitemap.xml exists and has > 80 image:image entries
3. dist/sitemap.xml exists and has sitemapindex format
4. Image captions contain category + location (not raw filenames)
5. All URLs are absolute (start with https://cassiecayphotography.com)
  </verify>
  <done>
- Build completes successfully with sitemap generation
- image-sitemap.xml contains 80+ portfolio images
- Each image has descriptive caption and Madison, WI geo_location
- sitemap.xml is sitemap index format
- Sitemaps are valid XML
  </done>
</task>

</tasks>

<verification>
Phase 18 requirements satisfied:
- SEO-07: Build-time script (scripts/generate-sitemap.js) generates sitemaps
- SEO-08: Captions derived from category + location, geo_location set to Madison, WI
- SEO-09: Main sitemap.xml converted to sitemap index format
- SEO-10: postbuild hook in package.json runs sitemap generation
</verification>

<success_criteria>
1. `npm run build` automatically generates image-sitemap.xml in dist/
2. image-sitemap.xml contains 80+ portfolio images with `<image:image>` entries
3. Each image has `<image:caption>` with category + location text
4. Each image has `<image:geo_location>` set to "Madison, Wisconsin, USA"
5. dist/sitemap.xml is sitemap index format referencing image-sitemap.xml
6. All URLs are absolute (https://cassiecayphotography.com/...)
</success_criteria>

<output>
After completion, create `.planning/phases/18-image-sitemap/18-01-SUMMARY.md`
</output>
