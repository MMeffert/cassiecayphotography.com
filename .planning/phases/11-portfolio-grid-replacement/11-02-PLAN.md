---
phase: 11-portfolio-grid-replacement
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - index.html
  - style/js/custom-scripts.js
autonomous: true

must_haves:
  truths:
    - "User can click filter buttons to show only matching category images"
    - "Filtered images animate smoothly (fade + scale)"
    - "Clicking portfolio image opens GLightbox with correct full-size image"
    - "Portfolio displays correctly at all responsive breakpoints"
    - "Masonry layout has no gaps between variable-height images"
  artifacts:
    - path: "index.html"
      provides: "Portfolio HTML with new IDs and classes"
      contains: "portfolio-grid"
    - path: "style/js/custom-scripts.js"
      provides: "Muuri initialization and filter logic"
      contains: "new Muuri"
  key_links:
    - from: "index.html filter buttons"
      to: "custom-scripts.js filterPortfolio()"
      via: "click event listeners on .filter-btn"
      pattern: "filter-btn.*addEventListener"
    - from: "custom-scripts.js grid.filter()"
      to: "GLightbox reload()"
      via: "onFinish callback"
      pattern: "onFinish.*lightbox\\.reload"
    - from: "custom-scripts.js Muuri init"
      to: "#portfolio-grid container"
      via: "selector parameter"
      pattern: "new Muuri.*portfolio-grid"
---

<objective>
Migrate portfolio HTML structure and implement Muuri filtering with GLightbox integration

Purpose: Replace Cubeportfolio initialization with Muuri, update HTML element IDs and classes, and wire up filter buttons with GLightbox reload on filter complete.

Output: Working portfolio grid with category filtering, masonry layout, and lightbox integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-portfolio-grid-replacement/11-RESEARCH.md
@.planning/phases/11-portfolio-grid-replacement/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update portfolio HTML structure</name>
  <files>index.html</files>
  <action>
Update the portfolio section HTML (around lines 205-1005):

1. **Filter container** - Change:
   - `id="cube-grid-mosaic-filter"` -> `id="portfolio-filter"`
   - `class="cbp-filter-container"` -> `class="portfolio-filter-container"`
   - Each filter div: `class="cbp-filter-item"` -> `class="filter-btn"`
   - Active filter: `class="cbp-filter-item-active cbp-filter-item"` -> `class="filter-btn active"`
   - Keep existing `data-filter` attributes (they work fine with our JS)

   Updated filter HTML:
   ```html
   <div id="portfolio-filter" class="portfolio-filter-container text-center">
     <div data-filter="*" class="filter-btn active">All</div>
     <div data-filter=".cat5" class="filter-btn">Couples</div>
     <div data-filter=".cat1" class="filter-btn">Family</div>
     <div data-filter=".cat2" class="filter-btn">Milestone</div>
     <div data-filter=".cat4" class="filter-btn">Newborn</div>
     <div data-filter=".cat3" class="filter-btn">Senior</div>
   </div>
   ```

2. **Portfolio grid container** - Change:
   - `id="cube-grid-mosaic"` -> `id="portfolio-grid"`
   - `class="cbp light-gallery"` -> `class="portfolio-grid light-gallery"`

3. **Portfolio items** (76 items) - Change each:
   - `class="cbp-item cat1"` -> `class="portfolio-item cat1"`
   - Wrap existing figure inside `<div class="portfolio-item-content">...</div>`

   Example item structure:
   ```html
   <div class="portfolio-item cat1">
     <div class="portfolio-item-content">
       <figure class="overlay overlay2">
         <a href="images-optimized/jpeg/full/cassiecay-F1-full.jpg">
           <picture>...</picture>
         </a>
       </figure>
     </div>
   </div>
   ```

4. **Remove Cubeportfolio-specific attributes**:
   - Remove `data-sub-html` attributes (GLightbox doesn't use them)
   - Remove hidden caption divs like `<div id="caption1" class="d-none">...</div>`

5. **Update comments**: Change `<!--/.cbp-item -->` to `<!--/.portfolio-item -->`
   and `<!--/.cbp -->` to `<!--/.portfolio-grid -->`

Important: Keep ALL category classes (cat1-cat5), picture elements, and overlay classes intact.
  </action>
  <verify>
```bash
grep -c "portfolio-item cat" index.html  # Should be 76
grep -c "portfolio-item-content" index.html  # Should be 76
grep -q 'id="portfolio-grid"' index.html && echo "Grid ID updated"
grep -q 'id="portfolio-filter"' index.html && echo "Filter ID updated"
grep -q 'class="filter-btn active"' index.html && echo "Filter button classes updated"
# Ensure no leftover Cubeportfolio classes in portfolio section
grep -c "cbp-item" index.html  # Should be 0
```
  </verify>
  <done>All 76 portfolio items updated with new class structure, filter buttons updated, Cubeportfolio-specific markup removed</done>
</task>

<task type="auto">
  <name>Task 2: Replace Cubeportfolio initialization with Muuri</name>
  <files>style/js/custom-scripts.js</files>
  <action>
Replace the Cubeportfolio section in custom-scripts.js (lines 119-156) with Muuri initialization:

1. **Remove Cubeportfolio code** (lines 119-156):
   - Delete `var $cubemosaic = $('#cube-grid-mosaic');`
   - Delete `$cubemosaic.find('img[loading="lazy"]').removeAttr('loading');`
   - Delete entire `$cubemosaic.cubeportfolio({...});` block
   - Delete `$cubemosaic.on('onAfterLoadMore.cbp', ...)` handler
   - Delete `$cubemosaic.on('onFilterComplete.cbp', ...)` handler

2. **Add Muuri initialization** (replace with):
```javascript
/*-----------------------------------------------------------------------------------*/
/*	PORTFOLIO GRID (Muuri - replaced Cubeportfolio in Phase 11)
/*-----------------------------------------------------------------------------------*/
var portfolioGrid = document.getElementById('portfolio-grid');
var grid = null;

if (portfolioGrid) {
    // Remove lazy loading from portfolio images before Muuri init
    // to ensure accurate dimensions for masonry layout
    portfolioGrid.querySelectorAll('img[loading="lazy"]').forEach(function(img) {
        img.removeAttribute('loading');
    });

    // Initialize Muuri grid
    grid = new Muuri('#portfolio-grid', {
        items: '.portfolio-item',
        layout: {
            fillGaps: true,      // Enable masonry-style packing (PORT-06)
            horizontal: false,
            alignRight: false,
            alignBottom: false
        },
        showDuration: 300,
        hideDuration: 200,
        layoutDuration: 300,
        visibleStyles: {
            opacity: 1,
            transform: 'scale(1)'
        },
        hiddenStyles: {
            opacity: 0,
            transform: 'scale(0.5)'
        }
    });

    // Filter function with GLightbox integration (PORT-02, PORT-04)
    function filterPortfolio(category) {
        grid.filter(function(item) {
            if (category === '*') return true;
            var categoryClass = category.replace('.', '');
            return item.getElement().classList.contains(categoryClass);
        }, {
            onFinish: function() {
                // Delay lightbox reload to ensure DOM updates complete
                setTimeout(function() {
                    lightbox.reload();
                }, 50);
            }
        });
    }

    // Bind filter button click handlers (PORT-02)
    document.querySelectorAll('.filter-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var category = this.getAttribute('data-filter');

            // Update active state
            document.querySelectorAll('.filter-btn').forEach(function(b) {
                b.classList.remove('active');
            });
            this.classList.add('active');

            // Apply filter with optional View Transitions enhancement (PORT-05)
            if (document.startViewTransition) {
                document.startViewTransition(function() {
                    filterPortfolio(category);
                });
            } else {
                filterPortfolio(category);
            }
        });
    });

    // Debounced resize handler for responsive layout
    var resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            grid.refreshItems().layout();
        }, 200);
    });
}
```

3. **Ensure GLightbox is initialized BEFORE Muuri**:
   - GLightbox init (lines 111-118) must remain before the portfolio grid code
   - The `lightbox` variable must be accessible to the filterPortfolio function

4. **Update image overlay prepend** (line 107):
   Change selector from `.overlay > a, .overlay > span` to include portfolio items:
   ```javascript
   $('.overlay > a, .overlay > span, .portfolio-item-content .overlay > a').prepend('<span class="bg"></span>');
   ```

   Actually, the existing selector should work since we're keeping the overlay class structure. Leave it as is.
  </action>
  <verify>
```bash
grep -q "new Muuri" style/js/custom-scripts.js && echo "Muuri initialized"
grep -q "filterPortfolio" style/js/custom-scripts.js && echo "Filter function present"
grep -q "lightbox.reload()" style/js/custom-scripts.js && echo "GLightbox reload wired"
grep -q "filter-btn" style/js/custom-scripts.js && echo "Filter buttons bound"
grep -q "fillGaps: true" style/js/custom-scripts.js && echo "Masonry enabled"
# Ensure Cubeportfolio code is removed
grep -q "cubeportfolio" style/js/custom-scripts.js || echo "Cubeportfolio removed"
```
  </verify>
  <done>Cubeportfolio initialization replaced with Muuri, filter function with GLightbox reload, View Transitions API enhancement, and resize handler</done>
</task>

<task type="auto">
  <name>Task 3: Test build and verify functionality</name>
  <files>none (verification only)</files>
  <action>
Run the build and verify no errors:

1. Run build:
   ```bash
   npm run build
   ```

2. Start dev server and test in browser:
   ```bash
   npm run dev
   ```

3. Manual verification checklist (for next plan's human verification):
   - Portfolio grid displays with 4 columns on desktop
   - Clicking "Family" filter shows only cat1 items
   - Clicking "All" shows all items
   - Clicking image opens GLightbox
   - Resize browser to test breakpoints
   - No console errors
  </action>
  <verify>
```bash
npm run build 2>&1 | tail -20
# Should show successful build with no errors
```
  </verify>
  <done>Build passes with no errors, site ready for human verification</done>
</task>

</tasks>

<verification>
1. Build completes: `npm run build` exits 0
2. HTML has 76 `.portfolio-item` elements
3. HTML has 0 `.cbp-item` elements
4. JavaScript has Muuri init, no Cubeportfolio
5. Filter buttons have click handlers
6. GLightbox reload is called after filter
</verification>

<success_criteria>
- 76 portfolio items migrated to new class structure
- Filter container and buttons use new classes
- Cubeportfolio JS completely removed from custom-scripts.js
- Muuri initialized with fillGaps: true for masonry
- Filter function updates active state and calls grid.filter()
- GLightbox reload() called in onFinish callback
- View Transitions API used as progressive enhancement
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-portfolio-grid-replacement/11-02-SUMMARY.md`
</output>
